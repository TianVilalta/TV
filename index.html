<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Taula</title>
  <style>
    :root{
      --bg:#f7fafc;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --danger:#ef4444;
      --border:#e6edf3;
    }
    body { font-family: Inter, system-ui, Arial, sans-serif; padding: 32px; background: linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%); color:#0f172a; }
    h1 { margin:0 0 16px; font-size:20px; color:#0b1220; }
    .wrap { max-width:40%; margin:0 auto; position:relative; }
    table { border-collapse: collapse; width:100%; background:var(--card); border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,0.08); }
    thead th { background:linear-gradient(90deg, rgba(37,99,235,0.06), rgba(37,99,235,0.03)); color:#0b1220; font-weight:600; padding:14px 16px; text-align:left; border-bottom:1px solid var(--border); }
    th, td { border-bottom:1px solid var(--border); padding:12px 16px; }
    tbody tr:last-child td { border-bottom: none; }
    td:first-child { width:65%; color:#0b1220; font-weight:500; }
    .controls { display:inline-flex; gap:8px; align-items:center; background:transparent; padding:4px; }
    .qty { min-width:36px; display:inline-block; text-align:center; font-weight:600; color:#0b1220; }
    button { border: none; background:transparent; cursor:pointer; padding:6px; border-radius:8px; transition:all .12s ease; display:inline-grid; place-items:center; width:36px; height:36px; box-shadow: inset 0 -1px 0 rgba(255,255,255,0.02); }
    button.increase { background: linear-gradient(180deg,var(--accent),#1e40af); color:white; }
    button.decrease { background: linear-gradient(180deg,#fff,#f8fafc); color:var(--danger); border:1px solid rgba(235,87,87,0.08); }
    button:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(2,6,23,0.08); }
    .meta { margin-top:12px; font-size:13px; color:var(--muted); }
    .badge { font-size:12px; padding:6px 8px; border-radius:999px; background:#eef2ff; color:var(--accent); display:inline-block; margin-left:8px; }

    /* floating add button */
    .fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width:56px;
      height:56px;
      border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#1e40af);
      color:white;
      display:grid;
      place-items:center;
      font-size:28px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.18);
      cursor:pointer;
      z-index: 60;
      border: none;
    }

    /* modal panel */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 70;
    }
    .overlay.show { display: flex; }
    .panel {
      background: var(--card);
      padding: 18px;
      border-radius: 12px;
      width: 360px;
      box-shadow: 0 12px 40px rgba(2,6,23,0.2);
    }
    .panel h2 { margin:0 0 12px; font-size:18px; }
    .field { margin-bottom:10px; }
    .field label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    .field input[type="text"], .field input[type="number"] {
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:14px;
    }
    .panel .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border: none; }
    .btn.primary { background:var(--accent); color:white; }
    .btn.ghost { background: #f3f4f6; color:#0b1220; }

    /* small responsive tweaks */
    @media (max-width:420px) {
      .panel { width: 92%; }
    }

    /* idle blackout overlay (most of the change) */
    #idleOverlay {
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease;
      z-index: 9999;
    }
    #idleOverlay.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Inventari</h1>

    <table>
      <thead>
        <tr>
          <th>Article</th>
          <th>Quantitat</th>
        </tr>
      </thead>
      <tbody id="rows-tbody">
        <!-- rows rendered dinamically -->
      </tbody>
    </table>
  </div>

  <!-- floating add button -->
  <button class="fab" id="addBtn" aria-label="Afegir article">+</button>

  <!-- modal form -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="panel" role="document">
      <h2>Afegir article</h2>
      <form id="addForm">
        <div class="field">
          <label for="articleName">Nom de l'article</label>
          <input id="articleName" name="name" type="text" required maxlength="80" />
        </div>
        <div class="field">
          <label for="articleQty">Quantitat inicial</label>
          <input id="articleQty" name="qty" type="number" min="0" value="0" />
        </div>
        <div class="actions">
          <button type="button" class="btn ghost" id="cancelAdd">-</button>
          <button type="submit" class="btn primary">+</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // dades i utilitats
    const STORAGE_KEY = 'rows';
    let rows = [];
    let nextId = 1;

    // si no hi ha res a localStorage, usar els valors inicials
    const initial = [
      { id: 1, name: 'Planxa lletres', qty: 7 },
      { id: 2, name: 'Suport', qty: 0 }
    ];

    function loadRows() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            rows = parsed.map(r => ({ id: Number(r.id) || 0, name: String(r.name || ''), qty: Math.max(0, parseInt(r.qty || 0, 10)) }));
          } else {
            rows = initial.slice();
          }
        } catch (e) {
          rows = initial.slice();
        }
      } else {
        rows = initial.slice();
        saveRows();
      }
      nextId = rows.reduce((m, r) => Math.max(m, r.id), 0) + 1;
    }

    function saveRows() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
    }

    // render
    const tbody = document.getElementById('rows-tbody');
    function renderRows() {
      tbody.innerHTML = rows.map(r => `
        <tr data-row="${r.id}">
          <td>${escapeHtml(r.name)}</td>
          <td>
            <div class="controls" data-row="${r.id}">
              <button type="button" class="decrease" aria-label="Restar">−</button>
              <span class="qty" aria-live="polite">${r.qty}</span>
              <button type="button" class="increase" aria-label="Sumar">+</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // escapem simples per evitar injectar HTML
    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // inicialització
    loadRows();
    renderRows();

    // delegació per + / - a la taula
    document.addEventListener('click', function (e) {
      const btn = e.target;
      const ctrl = btn.closest('.controls');
      if (!ctrl) return;
      const rowId = Number(ctrl.dataset.row);
      const qtyEl = ctrl.querySelector('.qty');
      let value = parseInt(qtyEl.textContent, 10) || 0;

      if (btn.classList.contains('increase')) {
        value += 1;
      } else if (btn.classList.contains('decrease')) {
        value = Math.max(0, value - 1);
      } else {
        return;
      }

      qtyEl.textContent = value;

      // actualitzar l'array i guardar
      const idx = rows.findIndex(r => r.id === rowId);
      if (idx > -1) {
        rows[idx].qty = value;
        saveRows();
      }
    });

    // afegir nou article: UI handlers
    const addBtn = document.getElementById('addBtn');
    const overlay = document.getElementById('overlay');
    const addForm = document.getElementById('addForm');
    const cancelAdd = document.getElementById('cancelAdd');

    function openForm() {
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
      document.getElementById('articleName').focus();
    }
    function closeForm() {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
      addForm.reset();
    }

    addBtn.addEventListener('click', openForm);
    cancelAdd.addEventListener('click', closeForm);
    overlay.addEventListener('click', function (e) {
      if (e.target === overlay) closeForm();
    });

    addForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const name = (addForm.name.value || '').trim();
      let qty = parseInt(addForm.qty.value, 10);
      if (!name) return;
      if (Number.isNaN(qty) || qty < 0) qty = 0;
      const id = nextId++;
      const newRow = { id, name, qty };
      rows.push(newRow);
      saveRows();
      renderRows();
      closeForm();
    });

    // -------------------------
    // idle detection / blackout
    // -------------------------
    (function () {
      const IDLE_MS = 5 * 60 * 1000; // 5 minuts
      let idleTimer = null;

      // crear overlay a runtime per no tocar l'estructura HTML existent
      const idleOverlay = document.createElement('div');
      idleOverlay.id = 'idleOverlay';
      idleOverlay.setAttribute('aria-hidden', 'true');
      document.body.appendChild(idleOverlay);

      function showIdle() {
        idleOverlay.classList.add('show');
      }
      function hideIdle() {
        idleOverlay.classList.remove('show');
      }

      function resetIdleTimer() {
        hideIdle();
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(showIdle, IDLE_MS);
      }

      // events que considerem activitat
      const events = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'wheel', 'scroll'];
      events.forEach(ev => window.addEventListener(ev, resetIdleTimer, { passive: true }));

      // iniciar comptador
      resetIdleTimer();
    })();
  </script>
</body>
</html>
